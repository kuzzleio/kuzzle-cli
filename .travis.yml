---
# ------------------------
# Jobs configuration
# ------------------------
jobs:
  include:
    # ---------------------------------------
    # Linter
    # ---------------------------------------
    - stage: Tests
      name: ESLint
      language: node_js
      node_js: 10
      cache: npm
      install:
        - npm ci --silent
      script:
        - npm run --silent test:lint

    # ---------------------------------------
    # Integration tests
    # ---------------------------------------
    - stage: Tests
      name: "Integration tests - Node.js 10"
      language: node_js
      node_js: 10
      services: docker
      cache: npm
      install:
        - npm ci --silent
        - sudo sysctl -w vm.max_map_count=262144
        - $TRAVIS_BUILD_DIR/.ci/start_kuzzle.sh
      script:
        - npm run test:e2e

    # ---------------------------------------
    # Deployments
    # ---------------------------------------
    - stage: Deployments
      name: NPM.js
      language: node_js
      node_js: 10
      script: echo "Deploying Kuzzle CLI to NPM.js"
      deploy:
        provider: npm
        email: support@kuzzle.io
        api_key:
          secure: HZuU/hhHOtkotcqjAa16hfmTUJukCkCZoUyuMCCxYAnFxNX+lNAoSfZfTaagZAM9vVqviqQoFHend574RgeQcxSySz8G0M2Ca3F5iN3i3V5JtMKYJEfqHO6za1llogvNiGxTBpCAU4AyK5XAXmx41GKGMyFxtnIDTtVP8nAQV9lzCcVvjni3cT+RfeK6Iflw+T4bqnC5mYtqMzv9tuk0gyvik6+NBIr9ccNfdHvwu+M4c6d+gn2PlQ8c9+9i9lCSgiIx0Ankv621imINjlcsycaaA5Iv9UJUvOwvxEqKxJS1mts2n20w97n/4AL1S2GOm5yMK2cRLvqTNzEBNH4k8653klm4ztjlVBxKHsa94Fq3FbTMK/V3CVcnXOn//AM9ekGIA1FX9u3TvlshrF8iitCXcpRNGS/Ao8JW6azDH3kYqw8yyzdV+2f+ZxR5jMUKLIAwpfOcfGJ8cZ+AyZ1rm3MTdLZyDQO5hYi+IZSx7Cj5AErLtpHytXe0NjnmhRqtRmIL/Hg/JpP+SWvbEkiTpHWfDzJ51QCxchpECH40/qYUFszHqK6aA3dVLfvLGWyEGEk+hPAkZ4yhfkR6xczOfVDAw4SKw02+MTa2JJL8Sl+dY7iuYHAtbKcnCiGJ1oL+Bkv6YuFRUyztipnU28ZDy2xx/Av+8SgBfJVrzkV2PEU=
        on:
          repo: kuzzleio/kuzzle-cli
          branch: master
          tags: true

# ------------------------
# Stages configuration
# ------------------------
stages:
  - name: Tests
    if: type =~ /(cron|pull_request)/ OR (type = push AND branch =~ /^master|[0-9]+-(dev|stable)$/)
  - name: Deployments
    if: branch = master
