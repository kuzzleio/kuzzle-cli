---
# ------------------------
# Jobs configuration
# ------------------------
jobs:
  include:
    # ---------------------------------------
    # Linter
    # ---------------------------------------
    - stage: Tests
      name: ESLint
      language: node_js
      node_js: 10
      cache: npm
      install:
        - npm ci --silent
      script:
        - npm run --silent test:lint

    # ---------------------------------------
    # Integration tests
    # ---------------------------------------
    - stage: Tests
      name: "Integration tests - Node.js 10"
      language: node_js
      node_js: 10
      services: docker
      cache: npm
      install:
        - npm ci --silent
        - sudo sysctl -w vm.max_map_count=262144
        - $TRAVIS_BUILD_DIR/.ci/start_kuzzle.sh
      script:
        - npm run test:e2e

    # ---------------------------------------
    # Deployments
    # ---------------------------------------
    - stage: Deployments
      name: NPM.js
      language: node_js
      node_js: 10
      script: echo "Deploying Kuzzle CLI to NPM.js"
      deploy:
        provider: npm
        email: support@kuzzle.io
        api_key:
          secure: dvLiACtKQvXSAU4sPGSl607bqiBVV4dWKKv8a+OZG1HljsArMn9nFa3zFl/h/dLwhjxIXrsuaeDVUg0MCHcDrD/q249kXc+HDNdvKcWHQ87IDhT30q7ZVCheDWNLicAV4CeY9FWfrgvvcy+VrOLtx6hHEsEZpms5Hab2I4l55nwxhmZ52FAU74D+aandOafyaJ45f0IDmYKGaN/oQy89vCwPBL0ITfZEt2z9udzuy5QwqolE17MHilpw95ozhL05Ne3+4BIjR6wikLY8IZxsT4yM+LJhZK9ctXdpognbzbbk4fzSIh72qMsb4CMUP3b4bpe8zEb8bI0ygmiCJLFM/IVpCFE9W4JsyOQ6g3pZ6TBORn9OlMvo7ja73hqKPHtPEP1BceYjjSmIXyPvAZrShWppz+GH93wJCgSWk7sM5Csd45yxElmvHmOW2N9Ialhl+DHazkMTNAi84n20VAEGaE1vxk6O7IEim42FIdNcKK4SxqfxPWgJCaeW7ACtPpiYWyVnQ3463yp+sSO5ZctGVZsDDiNbw7SwVwARgv5iTUzt3tBiEF3T6Cq5tL5El4LAGhQmpBuvYMAMwJT+dUCrmApsl4WPN6nnZSU4wlTAxx9mYdumMetP6cOGcyrwQRqDv6SveNke84lkS2Gd3j6e0tNLsmaNh6cUI/PiT6OqGl4=
        on:
          repo: kuzzleio/kuzzle-cli
          branch: master

# ------------------------
# Stages configuration
# ------------------------
stages:
  - name: Tests
    if: type =~ /(cron|pull_request)/ OR (type = push AND branch =~ /^master|[0-9]+-(dev|stable)$/)
  - name: Deployments
    if: branch = master
