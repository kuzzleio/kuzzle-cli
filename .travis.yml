---
# ------------------------
# Jobs configuration
# ------------------------
jobs:
  include:
    # ---------------------------------------
    # Linter
    # ---------------------------------------
    - stage: Tests
      name: ESLint
      language: node_js
      node_js: 10
      cache: npm
      install:
        - npm ci --silent
      script:
        - npm run --silent test:lint

    # ---------------------------------------
    # Integration tests
    # ---------------------------------------
    - stage: Tests
      name: "Integration tests - Node.js 10"
      language: node_js
      node_js: 10
      services: docker
      cache: npm
      install:
        - npm ci --silent
        - sudo sysctl -w vm.max_map_count=262144
        - $TRAVIS_BUILD_DIR/.ci/start_kuzzle.sh
      script:
        - npm run test:e2e

    # ---------------------------------------
    # Deployments
    # ---------------------------------------
    - stage: Deployments
      name: NPM.js
      language: node_js
      node_js: 10
      script: echo "Deploying Kuzzle CLI to NPM.js"
      deploy:
        provider: npm
        email: support@kuzzle.io
        api_key:
          secure: rSc+7z/J1bgU9haKLyzk+tSLP3jH19bgLWVVLHZ9pqP5ImSJfyr3w4ZRcI9trqmWrfPiq03cg570mk5o1ozVvTLTuktENUQmPQnok+pnmcwlisZFyNOJhM2bl4IB2C2rsIGrUbaU6cE7EuYJYSm+URhUzPxwoznTUE0sq6+iWxBLQxqjxYlYGewa9i8itkOhqf0GIPgWyY/YqSrJci6pIaWpLR0utT329p4EcL7K4SKDjakufIDPu04B6FG7aphAhhXzrPrp1X/64AuFg90eXgh2L08P05jEI6uaKf1Ovf3ILjBOiwYtKIeQsf2vnT5aF1suaQ94d5gGbRt/ztYP3laZ3j8Xb/TqrXws5lwWYFKoamAipdEtJCY8jBl+a47GuUCf2f5LIkVfdtZ6JNt6UGeRoKZYcQ7RH7mVWhj6OpSeVnVVxfaK/LaNCaLS61xwEu7I5A07VUlSu5o0SEl9dWu0M8xROyMBwO1UFaCBJpZRv3mo7f7NFZyAMLxwR7MOfs0WnJESoD/19vf29p20HpWj8CIhtaO+mS3LnN7CYFKEW9/L4Vmhy9N2v68lltCGpndAk6FTBA0+zK0w8L6BaMO7hEi8rPz7YOd7YjASn9heay3y8JFO+ksl7DK1Yne4b6ZJVMT8Lq748ztpzbXEOIdeow+FQXNnLh6/oYajSb8=
        on:
          repo: kuzzleio/kuzzle-cli
          branch: master
          tags: true

# ------------------------
# Stages configuration
# ------------------------
stages:
  - name: Tests
    if: type =~ /(cron|pull_request)/ OR (type = push AND branch =~ /^master|[0-9]+-(dev|stable)$/)
  - name: Deployments
    if: branch = master
