---
# ------------------------
# Jobs configuration
# ------------------------
jobs:
  include:
    # ---------------------------------------
    # Linter
    # ---------------------------------------
    - stage: Tests
      name: ESLint
      language: node_js
      node_js: 10
      cache: npm
      install:
        - npm ci --silent
      script:
        - npm run --silent test:lint

    # ---------------------------------------
    # Integration tests
    # ---------------------------------------
    - stage: Tests
      name: "Integration tests - Node.js 10"
      language: node_js
      node_js: 10
      services: docker
      cache: npm
      install:
        - npm ci --silent
        - sudo sysctl -w vm.max_map_count=262144
        - $TRAVIS_BUILD_DIR/.ci/start_kuzzle.sh
      script:
        - npm run test:e2e

    # ---------------------------------------
    # Deployments
    # ---------------------------------------
    - stage: Deployments
      name: NPM.js
      language: node_js
      node_js: 10
      script: echo "Deploying Kuzzle CLI to NPM.js"
      deploy:
        provider: npm
        email: support@kuzzle.io
        api_key:
          secure: "g7nqSaoIXRUPez7ftClHu9f855+UzuY3jEq8HjC9lUv6KH5IBhh/53ICw5fipjxMspfnS2y8aYQxpitfVp++R71Q3dxm+hn3J72I4Qf8vPUbNTpsH2toUfzG5RLejsQtXD6uwFrXXQ+ocglHssufxSjc9GyVDDZTJP55LVpm/Dr1wpb/4gXF34TbWZenUIpQyYZCgFAW3MBR8KmRQEAXOJDG5kjj9GPhFCwzsSEx8ejk06lmJX8Bt/u5VMQ032y3aQw6ogyK98PqAsZPihkajmvB2Mi7tkFM7oh1NqNP0k/9f3t49D6c36Z0X12vL/GdvigYBqCQq8BAxbTP8v3O7ByF3OoikPyQqIyMlZw+n2x8/ytgNQjaRcfalw3JaLN+iILKFN9Dnd4yZhmi4KBpkiLJCmuGtu0pkJsu6HW1EvNbmVXY+Lf+xUbHW4cEPBrXu+U1pYGYhcPxAr6/xoeHXldLSRDjNFl1WPXqiNpVsHIRHiEmINtGN6fLCdw8xSysGTHGVI66x26syl3ZCqpSS8chJw3ajUaLsj5HoNewRMXOAKzT4SEkBQu2Rd3hT4x6PaL49sjD7SCO9rCrBdXVTGvhiru4CSo6aa0R5OU1+Lno09RmmGGaUZN5qxj0xBqT7tccscjmQNAYORvix8NxhkvLXg2+NfWAlKALaKvB1SM="
        on:
          repo: kuzzleio/kuzzle-cli
          branch: master
          tags: true

# ------------------------
# Stages configuration
# ------------------------
stages:
  - name: Tests
    if: type =~ /(cron|pull_request)/ OR (type = push AND branch =~ /^master|[0-9]+-(dev|stable)$/)
  - name: Deployments
    if: branch = master
